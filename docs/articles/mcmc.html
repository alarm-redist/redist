<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redistricting with MCMC and RSG • redist</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Redistricting with MCMC and RSG">
<meta property="og:description" content="redist">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">redist</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/redist.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/map-preproc.html">Map Pre-processing for Special Constraints</a>
    </li>
    <li>
      <a href="../articles/mcmc.html">Redistricting with MCMC and RSG</a>
    </li>
    <li>
      <a href="../articles/mpi-slurm.html">MPI / Slurm Sample Scripts</a>
    </li>
    <li>
      <a href="../articles/tidy-redist.html">Tidy `redist`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kosukeimai/redist/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mcmc_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Redistricting with MCMC and RSG</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kosukeimai/redist/blob/master/vignettes/mcmc.Rmd"><code>vignettes/mcmc.Rmd</code></a></small>
      <div class="hidden name"><code>mcmc.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">redist</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://igraph.org">igraph</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>The <code>redist</code> package is designed to allow for replicable redistricting simulations. The package comes loaded with data for simple testing and with functions to simulate redistricting and to run diagnostics on the redistricting plans created. These data form the basis for small-scale validations of sampling methods in <a href="https://imai.fas.harvard.edu/research/files/redist.pdf">Automated Redistricting Simulation Using Markov Chain Monte Carlo</a>. For larger scale validation, see <a href="https://imai.fas.harvard.edu/research/files/enumerate.pdf">The Essential Role of Empirical Validation in Legislative Redistricting Simulation</a>.</p>
<div id="adj" class="section level1">
<h1 class="hasAnchor">
<a href="#adj" class="anchor"></a>Adjacency-Based Redistricting</h1>
<p>We begin with a simple example of thinking about adjacency-based redistricting, using a small piece of Florida, named fl25. It can be loaded with the data command as follows. For more information on the data, see <a href="#data">the data section</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"fl25"</span><span class="op">)</span></code></pre></div>
<p>This Florida subset contains the shapefiles for the districts, which can be plotted with sf.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fl25</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">pop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
<p>In this map, the color represents the population, where darker colors are smaller populations. The 25 shapes outlined above are the precincts that we work with. A difficulty in redistricting is that the area of the precinct does not necessarily tell us anything about the population of the precinct. As such, we work with adjacency lists for the precincts.</p>
<p>If we number the districts from 1 to 25, we say that two districts are connected if they share a side, which is referred to as rook contiguity.</p>
<p>If we arbitrarily number the districts from the plot above, we can pick a small subset of them.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fl25</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span>
<span class="va">fl25</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>,<span class="fl">13</span>,<span class="fl">1</span>,<span class="fl">14</span>,<span class="fl">15</span><span class="op">)</span>,<span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-4-1.png" width="480"></p>
<p>Then, the 15th precinct by this numbering is connected to 1, 13, and 14. So, the adjacency list would be 1,13,14. 12, for example, would not be on this list, as it does not share a portion of a side with precinct 25.</p>
<p>To make an adjacency list, we may use the packages <code>spdep</code> with function <code>poly2nb</code>. We use this function with <code>queen = FALSE</code>, as we want the rooks adjacency, not the queens adjacency, which would allow for if only corners touch, like on a chess board.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adjlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spdep/man/poly2nb.html">poly2nb</a></span><span class="op">(</span>pl <span class="op">=</span> <span class="va">fl25</span>, queen <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>We can further verify the above comments by looking at the 25th element of the adjacency list, which corresponds to the 25th district.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adjlist</span><span class="op">[[</span><span class="fl">25</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; [1]  5 22 24</span></code></pre></div>
<p>Using igraph, we can easily plot the whole set of adjacencies:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/graph_from_adj_list.html">graph_from_adj_list</a></span><span class="op">(</span><span class="va">adjlist</span>, mode <span class="op">=</span> <span class="st">'total'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<p>While these are numbered in 1:25, the back end in C++ requires 0 indexing for efficiency, so we sink the adjacency list to be 0:24.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span><span class="op">{</span>
  <span class="va">adjlist</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adjlist</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span>
<span class="op">}</span></code></pre></div>
<p>Thus, everything is the same up to naming.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adjlist</span><span class="op">[[</span><span class="fl">25</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; [1]  4 21 23</span></code></pre></div>
<p>Each algorithm within the package maintains geographically contiguous districts. The <code>MCMC</code> and <code>enumerate</code> algorithms consider the underlying graphical structure of the districts, where contiguity is represented by the edges in the above graph.</p>
<p><a href="#top">Back to top</a></p>
</div>
<div id="mcmc" class="section level1">
<h1 class="hasAnchor">
<a href="#mcmc" class="anchor"></a>Redistricting with MCMC</h1>
<p>To begin running the MCMC algorithm, we have to provide some basic data. We provide the adjacency list to <code>adjobj</code>, a vector of populations to <code>popvec</code>, the number of districts as 3 to <code>ndists</code>, and choose to run 10000 simulations with <code>nsims</code>. We can also save the output with <code>savename</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alg_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redist.mcmc.html">redist.mcmc</a></span><span class="op">(</span>adj <span class="op">=</span> <span class="va">adjlist</span>, total_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>,
                        ndists <span class="op">=</span> <span class="fl">3</span>, nsims <span class="op">=</span> <span class="fl">10000</span>, savename <span class="op">=</span> <span class="st">"redist.mcmc"</span><span class="op">)</span></code></pre></div>
<p>Note that we do not need to specify <code>ndists</code> when we supply a different argument, <code>initcds</code>, which is the set of districts to initialize to. If we do not specific <code>initcds</code>, the <a href="#rsg">RSG</a> function is run to initialize districts. When tuning parameters, the <code>initcds</code> argument may be useful for ensuring diverse starting positions for different chains, though this is not typically necessary.</p>
<p>We can specify <code>initcds</code>, for example, as the first column of the full enumeration in <code>algdat.pfull</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">fl25_enum</span><span class="op">)</span>
<span class="va">init_plan</span> <span class="op">&lt;-</span> <span class="va">fl25_enum</span><span class="op">$</span><span class="va">plans</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alg_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redist.mcmc.html">redist.mcmc</a></span><span class="op">(</span>adj <span class="op">=</span> <span class="va">adjlist</span>, total_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>,
                        init_plan <span class="op">=</span> <span class="va">init_plan</span>, nsims <span class="op">=</span> <span class="fl">10000</span>,
                        savename <span class="op">=</span> <span class="st">"redist.mcmc"</span><span class="op">)</span></code></pre></div>
<p>Once we’ve run the algorithm, the output is of class <code>redist</code>. As <code>savename</code> was provided, there is an Rdata file created in the working directory with a copy of the output.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">alg_mcmc</span><span class="op">)</span>
<span class="co">#&gt; [1] "redist"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">alg_mcmc</span><span class="op">)</span>
<span class="co">#&gt;  [1] "plans"                  "distance_parity"        "distance_original"     </span>
<span class="co">#&gt;  [4] "mhdecisions"            "mhprob"                 "pparam"                </span>
<span class="co">#&gt;  [7] "beta_sequence"          "energy_psi"             "constraint_pop"        </span>
<span class="co">#&gt; [10] "constraint_compact"     "constraint_segregation" "constraint_vra"        </span>
<span class="co">#&gt; [13] "constraint_similar"     "constraint_countysplit" "constraint_partisan"   </span>
<span class="co">#&gt; [16] "constraint_minority"    "constraint_hinge"       "boundary_partitions"   </span>
<span class="co">#&gt; [19] "boundaryratio"          "algorithm"              "pct_dist_parity"       </span>
<span class="co">#&gt; [22] "nsims"                  "adj"</span></code></pre></div>
<p>For simple runs of the algorithm, the most important pieces of the output are <code>plans</code> and <code>distance_parity</code>. The <code>plans</code> object is a matrix with <code>ndist</code> rows and <code>nsims</code> columns. Each column is one redistricting plan, where the numbers go from 0 to n-1, with each number represents the district assignment.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alg_mcmc</span><span class="op">$</span><span class="va">plans</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt;  [1] 0 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1 2 2 2 2</span></code></pre></div>
<p>The <code>distance_parity</code> output provides the population parity of the districts as an array with <code>nsims</code> entries.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alg_mcmc</span><span class="op">$</span><span class="va">distance_parity</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="co">#&gt; [1] 1.449798</span></code></pre></div>
<p>The additional outputs are useful for implementing the algorithm with constraints.</p>
<p><a href="#top">Back to top</a></p>
</div>
<div id="mpi" class="section level1">
<h1 class="hasAnchor">
<a href="#mpi" class="anchor"></a>Redistricting with MCMC using MPI</h1>
<p>The running of this function is the same as in redist.mcmc, but it requires Rmpi installed.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">Rmpi</span><span class="op">)</span>
<span class="fu"><a href="../reference/redist.mcmc.mpi.html">redist.mcmc.mpi</a></span><span class="op">(</span>adjobj <span class="op">=</span> <span class="va">adjlist</span>, popvec <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>,
                nsims <span class="op">=</span> <span class="fl">10000</span>,  ndists <span class="op">=</span> <span class="fl">3</span>, savename <span class="op">=</span> <span class="st">"redist.mcmc.mpi"</span><span class="op">)</span></code></pre></div>
<p>Outputs and usage are the same as in the <a href="#mcmc">MCMC Section</a>, but MPI will allow for much faster computation.</p>
<p><a href="#top">Back to top</a></p>
</div>
<div id="chains" class="section level1">
<h1 class="hasAnchor">
<a href="#chains" class="anchor"></a>Using Multiple Chains</h1>
<p>When running larger redistricting analyses, one important step is to run multiple chains of the MCMC algorithm. This will also allow us to diagnose convergence better, using the Gelman-Rubin plot, as seen in the section on <a href="#diag">Diagnostic Plots</a>.</p>
<p>On Windows and in smaller capacities, it is useful to run the algorithm within an lapply loop. First, we set up the seed for replicability and decide on the number of chains and simulations.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">RNGkind</a></span><span class="op">(</span>kind <span class="op">=</span> <span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">nsims</span> <span class="op">&lt;-</span> <span class="fl">10000</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
          <span class="fu"><a href="../reference/redist.mcmc.html">redist.mcmc</a></span><span class="op">(</span>adjobj <span class="op">=</span> <span class="va">adjlist</span>,  popvec <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>, 
                      nsims <span class="op">=</span> <span class="va">nsims</span>, ndists <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'adjobj' is deprecated.</span>
<span class="co">#&gt; Use 'adj' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; Warning: 'popvec' is deprecated.</span>
<span class="co">#&gt; Use 'total_pop' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; redist.mcmc(): Automated Redistricting Simulation Using</span>
<span class="co">#&gt;          Markov Chain Monte Carlo</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Preprocessing data.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; Using redist.rsg() to generate starting values.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Starting swMH().</span>
<span class="co">#&gt; 10 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.966967</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 20 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.958479</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 30 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.959987</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 40 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.96124</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 50 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.964593</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 60 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.963327</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 70 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.964281</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 80 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.96387</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 90 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.963663</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 100 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.963296</span>
<span class="co">#&gt; Warning: 'adjobj' is deprecated.</span>
<span class="co">#&gt; Use 'adj' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'popvec' is deprecated.</span>
<span class="co">#&gt; Use 'total_pop' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; redist.mcmc(): Automated Redistricting Simulation Using</span>
<span class="co">#&gt;          Markov Chain Monte Carlo</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Preprocessing data.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; Using redist.rsg() to generate starting values.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Starting swMH().</span>
<span class="co">#&gt; 10 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.967968</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 20 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.971986</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 30 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.969657</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 40 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.969742</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 50 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.970394</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 60 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.970495</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 70 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.967853</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 80 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.966621</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 90 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.967107</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 100 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.966097</span>
<span class="co">#&gt; Warning: 'adjobj' is deprecated.</span>
<span class="co">#&gt; Use 'adj' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'popvec' is deprecated.</span>
<span class="co">#&gt; Use 'total_pop' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; redist.mcmc(): Automated Redistricting Simulation Using</span>
<span class="co">#&gt;          Markov Chain Monte Carlo</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Preprocessing data.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; Using redist.rsg() to generate starting values.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Starting swMH().</span>
<span class="co">#&gt; 10 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.953954</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 20 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.958979</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 30 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.955652</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 40 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.956989</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 50 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.958792</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 60 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960993</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 70 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960709</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 80 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.959995</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 90 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.959884</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 100 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960696</span>
<span class="co">#&gt; Warning: 'adjobj' is deprecated.</span>
<span class="co">#&gt; Use 'adj' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'popvec' is deprecated.</span>
<span class="co">#&gt; Use 'total_pop' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; redist.mcmc(): Automated Redistricting Simulation Using</span>
<span class="co">#&gt;          Markov Chain Monte Carlo</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Preprocessing data.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; Using redist.rsg() to generate starting values.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Starting swMH().</span>
<span class="co">#&gt; 10 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960961</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 20 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.96098</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 30 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.96032</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 40 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.96074</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 50 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960392</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 60 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960827</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 70 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960137</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 80 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.95987</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 90 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960662</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 100 percent done.</span>
<span class="co">#&gt; Metropolis acceptance ratio: 0.960496</span></code></pre></div>
<p>In unix-based systems, this can be run considerably faster by running this in parallel.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mcmc_chains</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
          <span class="fu"><a href="../reference/redist.mcmc.html">redist.mcmc</a></span><span class="op">(</span>adjobj <span class="op">=</span> <span class="va">adjlist</span>,  popvec <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>, 
                      nsims <span class="op">=</span> <span class="va">nsims</span>, ndists <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span>, mc.set.seed <span class="op">=</span> <span class="fl">1</span>, mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><a href="#top">Back to top</a></p>
</div>
<div id="rsg" class="section level1">
<h1 class="hasAnchor">
<a href="#rsg" class="anchor"></a>Random Seed Growth</h1>
<p>This package also contains an implementation of Chen and Rodden’s non-compact Random Seed and Grow redistricting algorithm from their paper <a href="https://web.stanford.edu/~jrodden/wp/florida.pdf">Unintentional Gerrymandering: Political Geography and Electoral Biases in Legislatures</a>.</p>
<p>The adjacency list, via <code>adj</code>, is created as in <a href="#adj">Adjacency-Based Redistricting</a>, <code>total_pop</code> is the population of the districts, <code>ndists</code> is the number of districts, and <code>pop_tol</code> is the allowed population parity. A <code>pop_tol</code> of <code>0.05</code> allows for 5% population parity. In easier redistricting questions, a small <code>maxiter</code> is typically sufficient, but in large maps, values may be closer to <code>50,000</code> to ensure that a solution is found.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redist.rsg.html">redist.rsg</a></span><span class="op">(</span>adj <span class="op">=</span> <span class="va">adjlist</span>, total_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span>,
                  ndists <span class="op">=</span> <span class="fl">3</span>, pop_tol <span class="op">=</span> <span class="fl">0.05</span>,  maxiter <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ==================== </span>
<span class="co">#&gt; redist.rsg(): Automated Redistricting Starts</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  3 districts built using 25 precincts in 0 seconds...</span></code></pre></div>
<p>The output of <code>redist.rsg</code> is a list with three objects. <code>district_membership</code> provides a numeric array with indices for which district each precinct belongs to.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsg</span><span class="op">$</span><span class="va">plan</span>
<span class="co">#&gt;  [1] 0 0 0 0 1 2 1 1 2 1 1 0 0 2 2 2 2 2 0 0 2 0 2 1 0</span></code></pre></div>
<p><code>district_list</code> will provide an alternate formulation of this with <code>ndists</code> arrays, indicating which precincts are in each district.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsg</span><span class="op">$</span><span class="va">district_list</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;  [1] 19  3 18  1 21  0 12  2 24 11</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 10  9  7  6  4 23</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 14 13  8  5 22 20 17 15 16</span></code></pre></div>
<p>Corresponding to this, <code>district_pop</code> will give the district population for each of the <code>ndists</code> districts.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsg</span><span class="op">$</span><span class="va">district_pop</span>
<span class="co">#&gt; [1] 56287 59124 59632</span></code></pre></div>
<p><a href="#top">Back to top</a></p>
</div>
<div id="seg" class="section level1">
<h1 class="hasAnchor">
<a href="#seg" class="anchor"></a>Segregation Index</h1>
<p>To evaluate redistricting plans, the <code>redist</code> package comes with the <code>redist.segcalc</code> function. This computes the segregation index introduced in Massey and Denton 1987.</p>
<p>It takes three arguments, <code>algout</code>, which is a <code>redist</code> object from the various <code>mcmc</code> function or <code>rsg</code> function, <code>grouppop</code> which is the population of the group being used for comparison, and <code>fullpop</code> is the total population of the precinct.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redist.segcalc.html">redist.segcalc</a></span><span class="op">(</span>algout <span class="op">=</span> <span class="va">alg_mcmc</span>, group_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">BlackPop</span>,
                      total_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'algout' is deprecated.</span>
<span class="co">#&gt; Use 'plans' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span></code></pre></div>
<p>This returns a numeric vector with the an entry for each district provided.</p>
<p><a href="#top">Back to top</a></p>
</div>
<div id="diag" class="section level1">
<h1 class="hasAnchor">
<a href="#diag" class="anchor"></a>Diagnostic Plots</h1>
<p>When using the MCMC algorithms, there are various useful diagnostic plots. The <code>redist.diagplot</code> function creates familiar plots by converting numeric entries into <code>mcmc</code> objects to use with <code>coda</code>.</p>
<p>The first four plots take a single index, such as one created by <code>redist.segcalc</code>. * Trace Plot</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/redist.diagplot.html">redist.diagplot</a></span><span class="op">(</span><span class="va">seg</span>, plot <span class="op">=</span> <span class="st">"trace"</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<ul>
<li>Autocorrelation Plot</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/redist.diagplot.html">redist.diagplot</a></span><span class="op">(</span><span class="va">seg</span>, plot <span class="op">=</span> <span class="st">"autocorr"</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<ul>
<li>Density Plot</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/redist.diagplot.html">redist.diagplot</a></span><span class="op">(</span><span class="va">seg</span>, plot <span class="op">=</span> <span class="st">"densplot"</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<ul>
<li>Mean Plot</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/redist.diagplot.html">redist.diagplot</a></span><span class="op">(</span><span class="va">seg</span>, plot <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>The final plot requires at least two chains.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seg_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span>, 
                     <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="../reference/redist.segcalc.html">redist.segcalc</a></span><span class="op">(</span>algout <span class="op">=</span> <span class="va">mcmc_chains</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, 
                                  group_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">BlackPop</span>,
                                  total_pop <span class="op">=</span> <span class="va">fl25</span><span class="op">$</span><span class="va">pop</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Warning: 'algout' is deprecated.</span>
<span class="co">#&gt; Use 'plans' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'algout' is deprecated.</span>
<span class="co">#&gt; Use 'plans' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'algout' is deprecated.</span>
<span class="co">#&gt; Use 'plans' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="co">#&gt; Warning: 'algout' is deprecated.</span>
<span class="co">#&gt; Use 'plans' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span>

<span class="fu"><a href="../reference/redist.diagplot.html">redist.diagplot</a></span><span class="op">(</span><span class="va">seg_chains</span>, plot <span class="op">=</span> <span class="st">'gelmanrubin'</span><span class="op">)</span></code></pre></div>
<p><img src="mcmc_files/figure-html/unnamed-chunk-31-1.png" width="700"> Beware that this diagnostic will often fail to converge if there are insufficient iterations. If an error is thrown and no plot is created, try increasing <code>nsims</code>.</p>
<p><a href="#top">Back to top</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ben Fifield, Christopher T. Kenny, Cory McCartan, Jun Kawahara, Kosuke Imai.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
